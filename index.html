<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Todo List</title>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <style>
      .list-group-item.dragging {
        opacity: 0.5;
        background-color: #e9ecef;
      }
    </style>
  </head>
  <body class="d-flex flex-column min-vh-100 bg-light">
    <header>
      <nav class="navbar navbar-dark bg-primary shadow-sm">
        <div class="container">
          <a class="navbar-brand" href="#">
            <i class="bi bi-card-checklist"></i>
            Aplikasi Todo List
          </a>
        </div>
      </nav>
    </header>

    <main class="container my-5">
      <div class="card shadow-sm">
        <div class="card-body">
          <h1 class="h4 card-title">Apa rencana kamu selanjutnya?</h1>
          <form id="formData">
            <div class="mb-3">
              <div class="input-group">
                <input
                  type="text"
                  class="form-control"
                  name="todo"
                  placeholder="Contoh: Belajar JavaScript"
                />
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-plus-lg"></i> Tambah
                </button>
              </div>
            </div>
          </form>

          <hr />
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="flex-grow-1 me-3">
              <input
                type="text"
                id="search-input"
                class="form-control"
                placeholder="Cari todo..."
              />
            </div>
            <div class="btn-group" role="group" id="filter-buttons">
              <button
                type="button"
                class="btn btn-outline-primary active"
                data-filter="all"
              >
                Semua
              </button>
              <button
                type="button"
                class="btn btn-outline-primary"
                data-filter="uncompleted"
              >
                Belum Selesai
              </button>
              <button
                type="button"
                class="btn btn-outline-primary"
                data-filter="completed"
              >
                Selesai
              </button>
            </div>
          </div>

          <ul class="list-group" id="todoList">
            <!-- Daftar todo akan dirender di sini -->
          </ul>
        </div>
      </div>
    </main>

    <footer class="mt-auto py-3 bg-white shadow-sm">
      <div class="container text-center">
        <span class="text-muted"
          >Copyright &copy; 2024 &middot; Dibuat dengan ❤️</span
        >
      </div>
    </footer>

    <script>
      let todos = [];
      let currentFilter = "all"; // 'all', 'completed', 'uncompleted'
      let searchTerm = "";
      let editingTodoId = null; // Menyimpan ID dari todo yang sedang diedit
      let draggedItem = null;

      function renderTodos() {
        const todoList = document.getElementById("todoList");
        todoList.innerHTML = "";
        // 1. Filter berdasarkan status
        let filteredTodos = todos.filter((item) => {
          if (currentFilter === "completed") {
            return item.completed;
          }
          if (currentFilter === "uncompleted") {
            return !item.completed;
          }
          return true; // 'all'
        });

        // 2. Filter berdasarkan pencarian
        if (searchTerm) {
          filteredTodos = filteredTodos.filter((item) =>
            item.todo.toLowerCase().includes(searchTerm)
          );
        }

        // 3. Render hasil filter
        if (filteredTodos.length === 0) {
          todoList.innerHTML = `<li class="list-group-item text-center text-muted">Tidak ada todo yang ditemukan.</li>`;
        } else {
          filteredTodos.forEach((item) => {
            const li = document.createElement("li");
            li.className = "list-group-item d-flex align-items-center";
            li.draggable = true;
            li.dataset.id = item.id;

            const isEditing = item.id === editingTodoId;

            const contentDiv = document.createElement("div");
            contentDiv.className = "flex-fill";

            if (isEditing) {
              const input = document.createElement("input");
              input.type = "text";
              input.className = "form-control form-control-sm";
              input.value = item.todo;
              contentDiv.appendChild(input);

              // Fokus ke input field saat mode edit
              setTimeout(() => input.focus(), 0);
            } else {
              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.className = "form-check-input me-2";
              checkbox.checked = item.completed;
              checkbox.addEventListener("change", () => {
                item.completed = checkbox.checked;
                saveAndRender();
              });

              const label = document.createElement("label");
              label.className = "form-check-label";
              label.style.textDecoration = item.completed
                ? "line-through"
                : "none";
              label.textContent = item.todo;

              contentDiv.appendChild(checkbox);
              contentDiv.appendChild(label);
            }

            const buttonsDiv = document.createElement("div");

            if (isEditing) {
              const saveButton = document.createElement("button");
              saveButton.className = "btn btn-sm btn-success";
              saveButton.innerHTML = '<i class="bi bi-check-lg"></i>';
              saveButton.addEventListener("click", () => {
                const newTodoText = contentDiv
                  .querySelector("input")
                  .value.trim();
                updateTodoText(item.id, newTodoText);
              });
              buttonsDiv.appendChild(saveButton);
            } else {
              const editButton = document.createElement("button");
              editButton.className = "btn btn-sm btn-outline-primary me-1";
              editButton.innerHTML = '<i class="bi bi-pencil"></i>';
              editButton.addEventListener("click", () => {
                editingTodoId = item.id;
                renderTodos();
              });

              const deleteButton = document.createElement("button");
              deleteButton.className = "btn btn-sm btn-outline-danger";
              deleteButton.innerHTML = '<i class="bi bi-trash"></i>';
              deleteButton.addEventListener("click", () => {
                if (confirm("Apakah Anda yakin ingin menghapus todo ini?")) {
                  todos = todos.filter((t) => t.id !== item.id);
                  saveAndRender();
                }
              });

              buttonsDiv.appendChild(editButton);
              buttonsDiv.appendChild(deleteButton);
            }

            li.appendChild(contentDiv);
            li.appendChild(buttonsDiv);
            todoList.appendChild(li);

            // Event Listeners untuk Drag and Drop
            li.addEventListener("dragstart", handleDragStart);
            li.addEventListener("dragover", handleDragOver);
            li.addEventListener("dragleave", handleDragLeave);
            li.addEventListener("dragend", handleDragEnd);
          });
        }
      }

      function saveTodos() {
        localStorage.setItem("todos", JSON.stringify(todos));
      }

      function saveAndRender() {
        saveTodos();
        renderTodos();
      }

      function updateTodoText(id, newText) {
        if (newText === "") {
          alert("Todo tidak boleh kosong!");
          return;
        }
        // Cek duplikat, kecuali untuk item itu sendiri
        const isDuplicate = todos.some(
          (item) =>
            item.id !== id && item.todo.toLowerCase() === newText.toLowerCase()
        );
        if (isDuplicate) {
          alert("Todo dengan judul yang sama sudah ada!");
          return;
        }
        const todoToUpdate = todos.find((item) => item.id === id);
        todoToUpdate.todo = newText;
        editingTodoId = null; // Keluar dari mode edit
        saveAndRender();
      }

      // --- Drag and Drop Handlers ---
      function handleDragStart(e) {
        draggedItem = this;
        // Menambahkan sedikit delay agar browser sempat merekam elemen yang di-drag
        setTimeout(() => {
          this.classList.add("dragging");
        }, 0);
      }

      function handleDragEnd() {
        this.classList.remove("dragging");
        draggedItem = null;

        // Update urutan array 'todos' berdasarkan urutan DOM yang baru
        const newOrderIds = [...document.querySelectorAll("#todoList li")].map(
          (li) => Number(li.dataset.id)
        );

        todos.sort(
          (a, b) => newOrderIds.indexOf(a.id) - newOrderIds.indexOf(b.id)
        );

        saveTodos(); // Simpan urutan baru tanpa merender ulang
      }

      function handleDragOver(e) {
        e.preventDefault();
        const afterElement = getDragAfterElement(this.parentElement, e.clientY);
        if (afterElement == null) {
          this.parentElement.appendChild(draggedItem);
        } else {
          this.parentElement.insertBefore(draggedItem, afterElement);
        }
      }

      function handleDragLeave() {
        // Tidak perlu aksi khusus
      }

      function getDragAfterElement(container, y) {
        const draggableElements = [
          ...container.querySelectorAll("li:not(.dragging)"),
        ];

        return draggableElements.reduce(
          (closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
              return { offset: offset, element: child };
            } else {
              return closest;
            }
          },
          { offset: Number.NEGATIVE_INFINITY }
        ).element;
      }

      document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("formData");
        const searchInput = document.getElementById("search-input");
        const filterButtons = document.getElementById("filter-buttons");
        const storedTodos = localStorage.getItem("todos");

        if (storedTodos) {
          todos = JSON.parse(storedTodos);
        }

        form.addEventListener("submit", function (event) {
          event.preventDefault();
          const todoInput = form.todo.value.trim();

          if (todoInput === "") {
            alert("Todo tidak boleh kosong!");
            return;
          }

          // Validasi judul duplikat (case-insensitive)
          const isDuplicate = todos.some(
            (item) => item.todo.toLowerCase() === todoInput.toLowerCase()
          );
          if (isDuplicate) {
            alert("Todo dengan judul yang sama sudah ada!");
            return;
          }

          todos.unshift({
            id: Date.now(), // ID unik berdasarkan timestamp
            todo: todoInput,
            completed: false,
          });

          form.todo.value = "";
          saveAndRender();
        });

        searchInput.addEventListener("input", function (event) {
          searchTerm = event.target.value.toLowerCase();
          renderTodos();
        });

        filterButtons.addEventListener("click", function (event) {
          if (event.target.tagName === "BUTTON") {
            // Hapus kelas 'active' dari semua tombol
            filterButtons
              .querySelectorAll("button")
              .forEach((btn) => btn.classList.remove("active"));
            // Tambah kelas 'active' ke tombol yang diklik
            event.target.classList.add("active");

            currentFilter = event.target.dataset.filter;
            renderTodos();
          }
        });

        renderTodos();
      });
    </script>
  </body>
</html>

